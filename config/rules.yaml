# =============================================================================
# Decision Engine - Rule Configuration
# =============================================================================
#
# BACKTESTED STRATEGY (2021-01-01 to 2026-01-25)
# Symbols: SLV, CCJ, CAT, MP, PPLT, UUUU, URNM, ETN, AVAV, IAUM
# Results: 309 trades, 57% win rate, +117.4% avg return
#
# Trading Philosophy: "Buy quality dips with confirmation"
# - Enhanced entry filters (volume, trend spread, price support)
# - Multiple confirmation signals (RSI recovery + MACD)
# - Trend continuation on pullbacks to moving averages
#
# Exit Strategy:
# - Profit target: 7%
# - Stop loss: 5%
# - Min confidence: 0.5
#
# =============================================================================

service:
  name: decision-engine
  version: "2.0.0"

# Only evaluate symbols listed in symbol_overrides.
# Context/indicator symbols (SPY, QQQ, sector ETFs) flow through stock.indicators
# but should NOT be evaluated for trading signals — context-service handles them.
evaluate_only_overrides: true

# -----------------------------------------------------------------------------
# ENHANCED RULES (Backtested - Primary Strategy)
# -----------------------------------------------------------------------------
rules:
  # PRIMARY: Enhanced dip buying with strict filters
  enhanced_buy_dip:
    enabled: true
    description: "Buy RSI < 35, volume confirmed, trend spread > 1.5%, price > SMA_200"
    rsi_oversold: 35.0
    rsi_extreme: 30.0
    min_trend_spread: 1.5
    require_volume_confirm: true
    weight: 2.0  # Primary entry signal

  # MOMENTUM: Catch reversals with RSI + MACD confluence
  momentum_reversal:
    enabled: true
    description: "Buy when RSI recovering from oversold AND MACD crossing bullish"
    rsi_recovery_min: 30.0
    rsi_recovery_max: 45.0
    weight: 1.8

  # CONTINUATION: Buy pullbacks in strong trends
  trend_continuation:
    enabled: true
    description: "Buy when price pulls back to SMA_20 in strong uptrend"
    pullback_tolerance_pct: 2.0
    weight: 1.5

  # SCALE-IN: Removed — philosophically dangerous at $888 account size.
  # Guards were insufficient (RSI 35 too loose, 2% drop too small, no earnings blackout).
  # Revisit at $10k+ with Telegram confirmation gate and earnings calendar integration.
  average_down:
    enabled: false
    description: "Add to position when RSI < 35 and price 2%+ below entry"
    rsi_extreme: 35.0
    max_scale_ins: 2
    min_drop_from_entry_pct: 2.0
    weight: 1.2

# -----------------------------------------------------------------------------
# LEGACY RULES (Disabled - kept for reference)
# -----------------------------------------------------------------------------
  # Original buy dip rule (replaced by enhanced_buy_dip)
  buy_dip_in_uptrend:
    enabled: false
    description: "Buy when RSI < 40 AND weekly uptrend intact (SMA_20 > SMA_50)"
    rsi_threshold: 40.0
    weight: 1.5

  # Original strong buy (replaced by momentum_reversal)
  strong_buy_signal:
    enabled: false
    description: "Buy when RSI < 35 AND full trend alignment (SMA_20 > SMA_50 > SMA_200)"
    rsi_threshold: 35.0
    weight: 2.0

  # Weekly Uptrend Check
  weekly_uptrend:
    enabled: false
    description: "Stock trending up over past week"
    weight: 1.0

  # Monthly Uptrend Check
  monthly_uptrend:
    enabled: false
    description: "Stock trending up over past month"
    weight: 0.8

# -----------------------------------------------------------------------------
# Supporting Indicator Rules
# -----------------------------------------------------------------------------
  # RSI Rules
  rsi_oversold:
    enabled: true
    description: "Classic oversold condition"
    threshold: 30.0
    extreme_threshold: 20.0
    weight: 1.0

  rsi_overbought:
    enabled: true
    description: "Classic overbought - potential exit"
    threshold: 70.0
    extreme_threshold: 80.0
    weight: 1.0

  # MACD Rules
  macd_bullish_crossover:
    enabled: false  # Covered by momentum_reversal
    description: "MACD crosses above signal line"
    weight: 1.0

  macd_bearish_crossover:
    enabled: true
    description: "MACD crosses below signal line - exit warning"
    weight: 1.0

  # Trend Rules
  trend_alignment:
    enabled: true
    description: "Full bullish alignment: SMA_20 > SMA_50 > SMA_200"
    weight: 1.2

  trend_break_warning:
    enabled: true
    description: "SMA_20 crosses below SMA_50 - uptrend may be ending"
    weight: 1.0

# -----------------------------------------------------------------------------
# Mining Stock Specific Rules
# -----------------------------------------------------------------------------
  # Commodity Breakout - miners leverage commodity moves 2-3x
  commodity_breakout:
    enabled: true
    description: "Buy miners when breaking out 2%+ above SMA_20 with momentum"
    breakout_threshold_pct: 2.0
    min_trend_strength: 1.0
    weight: 1.5

  # Miner-Metal Ratio Mean Reversion
  miner_metal_ratio:
    enabled: true
    description: "Buy miners when oversold at support (underperforming metal)"
    rsi_oversold: 35.0
    support_tolerance_pct: 3.0
    weight: 1.6

  # Dollar Weakness = Miner Strength
  dollar_weakness:
    enabled: true
    description: "Buy miners in strong uptrend (indicates USD weakness)"
    min_trend_spread: 2.0
    require_macd_positive: true
    weight: 1.3

  # Seasonality Filter
  seasonality:
    enabled: true
    description: "Adjust confidence based on seasonal patterns (Jan-Feb, Aug-Sep strong)"
    strong_month_boost: 0.10
    weak_month_penalty: 0.15
    weight: 1.0

  # Volume Breakout - critical for mining stocks
  volume_breakout:
    enabled: true
    description: "Buy miners on 1.5x+ volume breakouts"
    min_volume_ratio: 1.5
    breakout_threshold_pct: 2.0
    weight: 1.8

# -----------------------------------------------------------------------------
# Signal Aggregation (Backtested Settings)
# -----------------------------------------------------------------------------
aggregation:
  method: "consensus_boost"  # Boost confidence when multiple rules agree
  min_confidence: 0.5        # Backtested threshold
  require_consensus: true    # Require multiple rules to agree before signaling
  consensus_min_rules: 2     # Minimum rules that must trigger for a signal

# -----------------------------------------------------------------------------
# Exit Strategy (For Alert Service / Trading Journal)
# -----------------------------------------------------------------------------
exit_strategy:
  profit_target: 0.12  # 12% - best backtested performance
  stop_loss: 0.06      # 6% - best backtested performance
  # Risk/reward ratio: 2:1
  # Backtest results: 236 trades, 51.7% win rate, +157.1% avg return

# -----------------------------------------------------------------------------
# Ranking Configuration (Which stock to buy first?)
# -----------------------------------------------------------------------------
ranking:
  criteria: "composite"
  weights:
    dip_depth: 0.30      # Lower RSI = better entry
    trend_strength: 0.30  # Full SMA alignment preferred
    confidence: 0.25      # How many rules triggered
    volatility: 0.15      # Based on ATR

  # How often to publish rankings
  publish_interval_seconds: 60

  # Only rank if at least this many symbols have signals
  min_symbols_for_ranking: 2

# -----------------------------------------------------------------------------
# Output Configuration
# -----------------------------------------------------------------------------
output:
  # Publish individual symbol decisions
  publish_decisions: true
  decision_topic: "trading.decisions"

  # Publish cross-symbol rankings
  publish_rankings: true
  ranking_topic: "trading.rankings"

  # Debounce to avoid flooding (seconds)
  debounce_seconds: 5

  # Only publish signals above this confidence
  min_publish_confidence: 0.5

# -----------------------------------------------------------------------------
# Symbol-Specific Rule Overrides (Backtested 2021-01-01 to 2026-01-25)
# -----------------------------------------------------------------------------
# ONLY trade these symbols - they have proven backtested results.
# Removed: ETN (45.8% WR), HL (-47% DD), PAAS (0.17 Sharpe), FCX (0.18 Sharpe)
# -----------------------------------------------------------------------------
symbol_overrides:

  # =========================================================================
  # TIER 1 - BEST PERFORMERS (Sharpe > 0.75)
  # Backtested 2021-01-01 to 2026-02-22, daily signals + 5min exits
  # =========================================================================

  CCJ:
    description: "Cameco - Uranium (63.3% WR, +161.2%, 0.99 Sharpe, 2.97 PF)"
    rules:
      - trend_continuation
      - seasonality
      - death_cross
    exit_strategy:
      profit_target: 0.10
      stop_loss: 0.06
      max_loss_pct: 6.0
      cooldown_bars: 7
    min_confidence: 0.65

  CAT:
    description: "Caterpillar - Industrial (56.5% WR, +151%, 1.54 Sharpe, 2.88 PF)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - rsi_oversold
      - macd_bearish_crossover
      - trend_alignment
      - trend_break_warning
      - death_cross
      - seasonality
    exit_strategy:
      profit_target: 0.12
      stop_loss: 0.04
      max_loss_pct: 4.0
      cooldown_bars: 3
    min_confidence: 0.5

  WPM:
    description: "Wheaton Precious Metals (48.6% WR, +201.2%, 0.67 Sharpe, 2.47 PF)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - rsi_oversold
      - macd_bearish_crossover
      - trend_alignment
      - golden_cross
      - trend_break_warning
      - death_cross
      - seasonality
    exit_strategy:
      profit_target: 0.12
      stop_loss: 0.04
      max_loss_pct: 4.0
      cooldown_bars: 3
    min_confidence: 0.5

  PPLT:
    description: "Platinum ETF - The Compounder (59.4% WR, +72%, 0.81 Sharpe, 2.23 PF)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - trend_alignment
      - golden_cross
      - trend_break_warning
      - death_cross
    exit_strategy:
      profit_target: 0.06
      stop_loss: 0.04
      max_loss_pct: 4.0
      cooldown_bars: 3
    min_confidence: 0.65

  # =========================================================================
  # TIER 2 - GOOD PERFORMERS (Sharpe 0.5-0.75)
  # =========================================================================

  IAUM:
    description: "iShares Gold Micro (64.7% WR, +96.3%, 0.76 Sharpe, 3.96 PF, -11.8% DD)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - rsi_oversold
      - macd_bearish_crossover
      - trend_alignment
      - golden_cross
      - trend_break_warning
      - death_cross
      - seasonality
    exit_strategy:
      profit_target: 0.05
      stop_loss: 0.04
      max_loss_pct: 4.0
      cooldown_bars: 3
    min_confidence: 0.5

  URNM:
    description: "Uranium Mining ETF (44% WR, +103.7%, 0.72 Sharpe, 2.98 PF, -12.5% DD)"
    rules:
      - trend_continuation
      - seasonality
      - death_cross
    exit_strategy:
      profit_target: 0.12
      stop_loss: 0.04
      max_loss_pct: 4.0
      cooldown_bars: 7
    min_confidence: 0.65

  SLV:
    description: "Silver ETF (56.9% WR, +139.5%, 0.60 Sharpe, 3.05 PF, -17.9% DD)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - rsi_oversold
      - rsi_overbought
      - macd_bearish_crossover
      - trend_alignment
      - trend_break_warning
      - commodity_breakout
      - miner_metal_ratio
      - dollar_weakness
      - seasonality
      - volume_breakout
      - death_cross
    exit_strategy:
      profit_target: 0.12
      stop_loss: 0.04
      max_loss_pct: 4.0
      cooldown_bars: 7
    min_confidence: 0.5

  # =========================================================================
  # TIER 3 - HIGH RISK / HIGH REWARD (Use smaller position sizes)
  # =========================================================================

  MP:
    description: "MP Materials - Rare Earth (63.9% WR, +299.9%, 0.47 Sharpe, 3.21 PF, -26.3% DD)"
    rules:
      - trend_continuation
      - seasonality
      - death_cross
    exit_strategy:
      profit_target: 0.12
      stop_loss: 0.05
      max_loss_pct: 5.0
      cooldown_bars: 5
    min_confidence: 0.5

  UUUU:
    description: "Energy Fuels - Uranium (48.6% WR, +119.5%, 0.50 Sharpe, 1.89 PF, -33.9% DD)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - rsi_oversold
      - macd_bearish_crossover
      - trend_alignment
      - trend_break_warning
      - death_cross
      - seasonality
    exit_strategy:
      profit_target: 0.20
      stop_loss: 0.04
      max_loss_pct: 4.0
      cooldown_bars: 3
    min_confidence: 0.5

# -----------------------------------------------------------------------------
# DO NOT TRADE - Removed due to poor backtested performance:
# -----------------------------------------------------------------------------
# ETN:  45.8% WR, below 50% = losing strategy
# HL:   36.8% WR, -38.7% DD, -0.07 Sharpe = disaster
# PAAS: 48.1% WR, +14.2%, 0.17 Sharpe, -55.9% DD = not worth it
# FCX:  52.9% WR, +15.9%, 0.18 Sharpe, -39.5% DD = not worth it
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# Trade Plan Engine — deterministic entry/stop/target/R:R generation
# Every BUY decision is enriched with a complete trade plan before publishing.
# $0 cost — no LLM involved.
# -----------------------------------------------------------------------------
trade_plan_engine:
  enabled: true
  atr_multiplier: 2.0           # Stop = entry - (ATR_14 × atr_multiplier)
  min_rr_ratio: 2.0             # Plans with R:R below this set plan_valid=false + rr_warning
  stop_min_pct: 3.0             # Widen ATR stop if % distance < this (to 4%)
  stop_max_pct: 15.0            # Cap ATR stop if % distance > this (to 10%)
  default_account_balance: 888.80  # Fallback when Redis is unavailable
  account_balance_redis_key: "robinhood:portfolio"  # Redis hash → total_equity field
  validity_windows:
    oversold_bounce: "eod"       # Valid until end of trading day
    pullback_to_support: "2d"    # Valid for 2 trading days
    breakout: "2h"               # Valid for 2 hours (breakouts go or fail fast)
    signal: "eod"                # Generic signals valid until EOD
