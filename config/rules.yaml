# =============================================================================
# Decision Engine - Rule Configuration
# =============================================================================
#
# BACKTESTED STRATEGY (2021-01-01 to 2026-01-25)
# Symbols: SLV, CCJ, CAT, MP, PPLT, UUUU, URNM, ETN, AVAV, IAUM
# Results: 309 trades, 57% win rate, +117.4% avg return
#
# Trading Philosophy: "Buy quality dips with confirmation"
# - Enhanced entry filters (volume, trend spread, price support)
# - Multiple confirmation signals (RSI recovery + MACD)
# - Trend continuation on pullbacks to moving averages
#
# Exit Strategy:
# - Profit target: 7%
# - Stop loss: 5%
# - Min confidence: 0.5
#
# =============================================================================

service:
  name: decision-engine
  version: "2.0.0"

# -----------------------------------------------------------------------------
# ENHANCED RULES (Backtested - Primary Strategy)
# -----------------------------------------------------------------------------
rules:
  # PRIMARY: Enhanced dip buying with strict filters
  enhanced_buy_dip:
    enabled: true
    description: "Buy RSI < 35, volume confirmed, trend spread > 1.5%, price > SMA_200"
    rsi_oversold: 35.0
    rsi_extreme: 30.0
    min_trend_spread: 1.5
    require_volume_confirm: true
    weight: 2.0  # Primary entry signal

  # MOMENTUM: Catch reversals with RSI + MACD confluence
  momentum_reversal:
    enabled: true
    description: "Buy when RSI recovering from oversold AND MACD crossing bullish"
    rsi_recovery_min: 30.0
    rsi_recovery_max: 45.0
    weight: 1.8

  # CONTINUATION: Buy pullbacks in strong trends
  trend_continuation:
    enabled: true
    description: "Buy when price pulls back to SMA_20 in strong uptrend"
    pullback_tolerance_pct: 2.0
    weight: 1.5

  # SCALE-IN: Average down on deeper dips
  average_down:
    enabled: true  # Position tracking now implemented!
    description: "Add to position when RSI < 35 and price 2%+ below entry"
    rsi_extreme: 35.0
    max_scale_ins: 2
    min_drop_from_entry_pct: 2.0
    weight: 1.2

# -----------------------------------------------------------------------------
# LEGACY RULES (Disabled - kept for reference)
# -----------------------------------------------------------------------------
  # Original buy dip rule (replaced by enhanced_buy_dip)
  buy_dip_in_uptrend:
    enabled: false
    description: "Buy when RSI < 40 AND weekly uptrend intact (SMA_20 > SMA_50)"
    rsi_threshold: 40.0
    weight: 1.5

  # Original strong buy (replaced by momentum_reversal)
  strong_buy_signal:
    enabled: false
    description: "Buy when RSI < 35 AND full trend alignment (SMA_20 > SMA_50 > SMA_200)"
    rsi_threshold: 35.0
    weight: 2.0

  # Weekly Uptrend Check
  weekly_uptrend:
    enabled: false
    description: "Stock trending up over past week"
    weight: 1.0

  # Monthly Uptrend Check
  monthly_uptrend:
    enabled: false
    description: "Stock trending up over past month"
    weight: 0.8

# -----------------------------------------------------------------------------
# Supporting Indicator Rules
# -----------------------------------------------------------------------------
  # RSI Rules
  rsi_oversold:
    enabled: true
    description: "Classic oversold condition"
    threshold: 30.0
    extreme_threshold: 20.0
    weight: 1.0

  rsi_overbought:
    enabled: true
    description: "Classic overbought - potential exit"
    threshold: 70.0
    extreme_threshold: 80.0
    weight: 1.0

  # MACD Rules
  macd_bullish_crossover:
    enabled: false  # Covered by momentum_reversal
    description: "MACD crosses above signal line"
    weight: 1.0

  macd_bearish_crossover:
    enabled: true
    description: "MACD crosses below signal line - exit warning"
    weight: 1.0

  # Trend Rules
  trend_alignment:
    enabled: true
    description: "Full bullish alignment: SMA_20 > SMA_50 > SMA_200"
    weight: 1.2

  trend_break_warning:
    enabled: true
    description: "SMA_20 crosses below SMA_50 - uptrend may be ending"
    weight: 1.0

# -----------------------------------------------------------------------------
# Mining Stock Specific Rules
# -----------------------------------------------------------------------------
  # Commodity Breakout - miners leverage commodity moves 2-3x
  commodity_breakout:
    enabled: true
    description: "Buy miners when breaking out 2%+ above SMA_20 with momentum"
    breakout_threshold_pct: 2.0
    min_trend_strength: 1.0
    weight: 1.5

  # Miner-Metal Ratio Mean Reversion
  miner_metal_ratio:
    enabled: true
    description: "Buy miners when oversold at support (underperforming metal)"
    rsi_oversold: 35.0
    support_tolerance_pct: 3.0
    weight: 1.6

  # Dollar Weakness = Miner Strength
  dollar_weakness:
    enabled: true
    description: "Buy miners in strong uptrend (indicates USD weakness)"
    min_trend_spread: 2.0
    require_macd_positive: true
    weight: 1.3

  # Seasonality Filter
  seasonality:
    enabled: true
    description: "Adjust confidence based on seasonal patterns (Jan-Feb, Aug-Sep strong)"
    strong_month_boost: 0.10
    weak_month_penalty: 0.15
    weight: 1.0

  # Volume Breakout - critical for mining stocks
  volume_breakout:
    enabled: true
    description: "Buy miners on 1.5x+ volume breakouts"
    min_volume_ratio: 1.5
    breakout_threshold_pct: 2.0
    weight: 1.8

# -----------------------------------------------------------------------------
# Signal Aggregation (Backtested Settings)
# -----------------------------------------------------------------------------
aggregation:
  method: "consensus_boost"  # Boost confidence when multiple rules agree
  min_confidence: 0.5        # Backtested threshold
  require_consensus: false
  consensus_min_rules: 2

# -----------------------------------------------------------------------------
# Exit Strategy (For Alert Service / Trading Journal)
# -----------------------------------------------------------------------------
exit_strategy:
  profit_target: 0.12  # 12% - best backtested performance
  stop_loss: 0.06      # 6% - best backtested performance
  # Risk/reward ratio: 2:1
  # Backtest results: 236 trades, 51.7% win rate, +157.1% avg return

# -----------------------------------------------------------------------------
# Ranking Configuration (Which stock to buy first?)
# -----------------------------------------------------------------------------
ranking:
  criteria: "composite"
  weights:
    dip_depth: 0.30      # Lower RSI = better entry
    trend_strength: 0.30  # Full SMA alignment preferred
    confidence: 0.25      # How many rules triggered
    volatility: 0.15      # Based on ATR

  # How often to publish rankings
  publish_interval_seconds: 60

  # Only rank if at least this many symbols have signals
  min_symbols_for_ranking: 2

# -----------------------------------------------------------------------------
# Output Configuration
# -----------------------------------------------------------------------------
output:
  # Publish individual symbol decisions
  publish_decisions: true
  decision_topic: "trading.decisions"

  # Publish cross-symbol rankings
  publish_rankings: true
  ranking_topic: "trading.rankings"

  # Debounce to avoid flooding (seconds)
  debounce_seconds: 5

  # Only publish signals above this confidence
  min_publish_confidence: 0.5

# -----------------------------------------------------------------------------
# Symbol-Specific Rule Overrides (Backtested 2021-01-01 to 2026-01-25)
# -----------------------------------------------------------------------------
# ONLY trade these symbols - they have proven backtested results.
# Removed: ETN (45.8% WR), HL (-47% DD), PAAS (0.17 Sharpe), FCX (0.18 Sharpe)
# -----------------------------------------------------------------------------
symbol_overrides:

  # =========================================================================
  # TIER 1 - BEST PERFORMERS (Sharpe > 1.0)
  # =========================================================================

  CCJ:
    description: "Cameco - Uranium (57.1% WR, +492.4%, 1.17 Sharpe) TOP PICK"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - average_down
    exit_strategy:
      profit_target: 0.10
      stop_loss: 0.05
    min_confidence: 0.5

  CAT:
    description: "Caterpillar - Industrial (65.3% WR, +159%, 1.14 Sharpe)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - average_down
      - rsi_oversold
      - rsi_overbought
      - macd_bearish_crossover
      - trend_alignment
      - trend_break_warning
    exit_strategy:
      profit_target: 0.10
      stop_loss: 0.05
    min_confidence: 0.5

  WPM:
    description: "Wheaton Precious Metals (56.4% WR, +203.4%, 1.04 Sharpe)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - average_down
      - rsi_oversold
      - rsi_overbought
      - macd_bearish_crossover
      - trend_alignment
      - trend_break_warning
      - commodity_breakout
      - miner_metal_ratio
      - dollar_weakness
      - seasonality
      - volume_breakout
    exit_strategy:
      profit_target: 0.12
      stop_loss: 0.06
    min_confidence: 0.5

  PPLT:
    description: "Platinum ETF (59.6% WR, +133%, 1.03 Sharpe)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - average_down
      - rsi_oversold
      - rsi_overbought
      - macd_bearish_crossover
      - trend_alignment
      - trend_break_warning
    exit_strategy:
      profit_target: 0.10
      stop_loss: 0.05
    min_confidence: 0.5

  # =========================================================================
  # TIER 2 - GOOD PERFORMERS (Sharpe 0.5-1.0)
  # =========================================================================

  IAUM:
    description: "iShares Gold Micro (58.1% WR, +80%, 0.69 Sharpe, LOWEST DD -13.6%)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - average_down
      - rsi_oversold
      - rsi_overbought
      - macd_bearish_crossover
      - trend_alignment
      - trend_break_warning
    exit_strategy:
      profit_target: 0.10
      stop_loss: 0.05
    min_confidence: 0.5

  URNM:
    description: "Uranium Mining ETF (57.1% WR, +173.6%, 0.68 Sharpe)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - average_down
    exit_strategy:
      profit_target: 0.10
      stop_loss: 0.05
    min_confidence: 0.5

  SLV:
    description: "Silver ETF (55.2% WR, +265.8%, 0.60 Sharpe)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - average_down
      - rsi_oversold
      - rsi_overbought
      - macd_bearish_crossover
      - trend_alignment
      - trend_break_warning
      - commodity_breakout
      - miner_metal_ratio
      - dollar_weakness
      - seasonality
      - volume_breakout
    exit_strategy:
      profit_target: 0.12
      stop_loss: 0.06
    min_confidence: 0.5

  # =========================================================================
  # TIER 3 - HIGH RISK / HIGH REWARD (Use smaller position sizes)
  # =========================================================================

  MP:
    description: "MP Materials - Rare Earth (50% WR, +164%, 0.61 Sharpe, CAUTION: -39% DD)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - average_down
    exit_strategy:
      profit_target: 0.10
      stop_loss: 0.05
    min_confidence: 0.5

  UUUU:
    description: "Energy Fuels - Uranium (55.2% WR, +269.9%, 0.53 Sharpe, CAUTION: -32% DD)"
    rules:
      - enhanced_buy_dip
      - momentum_reversal
      - trend_continuation
      - average_down
    exit_strategy:
      profit_target: 0.10
      stop_loss: 0.05
    min_confidence: 0.5

# -----------------------------------------------------------------------------
# DO NOT TRADE - Removed due to poor backtested performance:
# -----------------------------------------------------------------------------
# ETN:  45.8% WR, below 50% = losing strategy
# HL:   36.8% WR, -38.7% DD, -0.07 Sharpe = disaster
# PAAS: 48.1% WR, +14.2%, 0.17 Sharpe, -55.9% DD = not worth it
# FCX:  52.9% WR, +15.9%, 0.18 Sharpe, -39.5% DD = not worth it
# -----------------------------------------------------------------------------
